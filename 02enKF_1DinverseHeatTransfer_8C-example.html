<!-- HTML header for doxygen 1.8.14-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.15"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ITHACA-FV: 02enKF_1DinverseHeatTransfer.C</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script><script type="text/javascript" async="async" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="customdoxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="ithaca-fv-small.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname"><a href="">ITHACA-FV</a>
   &#160;<span id="projectnumber"><a href="">5.0</a></span>
   </div>
   <div id="projectbrief"><a href="https://mathlab.sissa.it/">SISSA mathLab</a></div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.15 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">02enKF_1DinverseHeatTransfer.C</div>  </div>
</div><!--header-->
<div class="contents">
<h1><a class="anchor" id="intro_invProb"></a>
1D heat transfer state reconstruction</h1>
<p class="">The tutorial consists in the state reconstruction of a 1D heat transfer problem where we have some measurement points inside the domain but partially known boundary conditions.</p>
<p class="">The equations of the true problem are </p><p class="formulaDsp">
\begin{eqnarray*} \rho C_p\frac{\partial T}{\partial t} + k \Delta T &amp;=&amp; 0 &amp;\text{ in } (0,1) \times (0, t_f]\\ \nabla T \cdot \mathbf{n} &amp;=&amp; g_{true}(t) &amp;\text{ on } x=0 \times (0, t_f]\\ T &amp;=&amp; 0.5 &amp;\text{ on } x=1 \times (0, t_f]\\ T &amp;=&amp; T_0 &amp;\text{ on } (0,1) \times t=0 \end{eqnarray*}
</p>
<p> where \(\rho\), \(C_p\), \(k\) and \(T_0\) are defined by the user in the ITHACAdict and 0/T file while \(g_{true}(t) = 5 t + 2\) and \(T_0 = 1\).</p>
<p class="">The objective of the tutorial is to reconstruct the true solution having some noisy temperature measurements defined in the measurementsDict and the model </p><p class="formulaDsp">
\begin{eqnarray*} \rho C_p\frac{\partial T}{\partial t} + k \Delta T &amp;=&amp; 0 &amp;\text{ in } (0,1) \times (0, t_f]\\ \nabla T \cdot \mathbf{n} &amp;=&amp; g(t) &amp;\text{ on } x=0 \times (0, t_f]\\ T &amp;=&amp; 0.5 &amp;\text{ on } x=1 \times (0, t_f]\\ T &amp;=&amp; T_0 &amp;\text{ on } (0,1) \times t=0 \end{eqnarray*}
</p>
<p> where the boundary condition \(g(t)=5t\) is different from the right one \(g_{true}\).</p>
<p class="">To solve this problem, we use the Ensemble Kalman Filter implemented in the <a class="el" href="namespaceITHACAmuq_1_1muq2ithaca.html#a89f897049668ee183c5e422b7bbe35df" title="Ensemble Kalman Filter.">ITHACAmuq::muq2ithaca::EnsembleKalmanFilter</a> method. We start by assuming a Gaussian prior for the state (the temperature in this case) </p><p class="formulaDsp">
\[ \omega_{prior} \sim \mathcal{N}(T_0, \sigma_{prior}I). \]
</p>
<p> Then, we sample it creating the prior ensemble </p><p class="formulaDsp">
\[ E_{prior}^0. \]
</p>
<p class="">Now, at each timestep, we perform a forecasting step. In the forecasting step, we solve the direct problem with the "wrong" heat flux for each of the member of the ensemble adding to the solution the model error </p><p class="formulaDsp">
\[ \omega_{model} \sim \mathcal{N}(0, \sigma_{model}I). \]
</p>
<p> This way, we produced at each timestep a posterior ensamble </p><p class="formulaDsp">
\[ E_{post}^n. \]
</p>
<p class="">If there are no measurements available at this timestep </p><p class="formulaDsp">
\[ E_{post}^n = E_{prior}^{n-1}. \]
</p>
<p> However, when we have available measurements, we perform a Kalman filter correction step. The Kalman filter updates the posterior ensamble such that </p><p class="formulaDsp">
\[ \hat{E}_{post}^n = E_{post}^{n} + Z M, \]
</p>
<p> where </p><p class="formulaDsp">
\[ Z = \frac{1}{Nseeds - 1} A (HA)^T, \]
</p>
 <p class="formulaDsp">
\[ A = E_{prior}(i) - \mu_{prior}, \]
</p>
<p> {prior} being a matrix having the mean value on the ensemble repeated on each column. \(HA\) is similar to \(A\) but with the value of the state in the observation point, </p><p class="formulaDsp">
\[ M = P Y, \]
</p>
 <p class="formulaDsp">
\[ P = \frac{1}{Nseeds - 1} (HA) (HA)^T + \sigma_{meas} I, \]
</p>
<p> and \(Y\) is the matrix containing the difference between the measured and computed state at the measurement points.</p>
<p class="">The image below shows the true end reconstructed temperature at \(x=0.5\) together with the 95% quantile </p><div class="image">
<img src="02enKF_1DinverseHeatTransfer.png" alt="02enKF_1DinverseHeatTransfer.png"/>
</div>
<h1><a class="anchor" id="plaincode"></a>
The plain program</h1>
<p class="">Here there's the plain code</p>
<div class="fragment"><div class="line"><span class="comment">/*---------------------------------------------------------------------------*\</span></div><div class="line"><span class="comment">     ██╗████████╗██╗  ██╗ █████╗  ██████╗ █████╗       ███████╗██╗   ██╗</span></div><div class="line"><span class="comment">     ██║╚══██╔══╝██║  ██║██╔══██╗██╔════╝██╔══██╗      ██╔════╝██║   ██║</span></div><div class="line"><span class="comment">     ██║   ██║   ███████║███████║██║     ███████║█████╗█████╗  ██║   ██║</span></div><div class="line"><span class="comment">     ██║   ██║   ██╔══██║██╔══██║██║     ██╔══██║╚════╝██╔══╝  ╚██╗ ██╔╝</span></div><div class="line"><span class="comment">     ██║   ██║   ██║  ██║██║  ██║╚██████╗██║  ██║      ██║      ╚████╔╝</span></div><div class="line"><span class="comment">     ╚═╝   ╚═╝   ╚═╝  ╚═╝╚═╝  ╚═╝ ╚═════╝╚═╝  ╚═╝      ╚═╝       ╚═══╝</span></div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment"> * In real Time Highly Advanced Computational Applications for Finite Volumes</span></div><div class="line"><span class="comment"> * Copyright (C) 2017 by the ITHACA-FV authors</span></div><div class="line"><span class="comment">-------------------------------------------------------------------------------</span></div><div class="line"><span class="comment">License</span></div><div class="line"><span class="comment">    This file is part of ITHACA-FV</span></div><div class="line"><span class="comment">    ITHACA-FV is free software: you can redistribute it and/or modify</span></div><div class="line"><span class="comment">    it under the terms of the GNU Lesser General Public License as published by</span></div><div class="line"><span class="comment">    the Free Software Foundation, either version 3 of the License, or</span></div><div class="line"><span class="comment">    (at your option) any later version.</span></div><div class="line"><span class="comment">    ITHACA-FV is distributed in the hope that it will be useful,</span></div><div class="line"><span class="comment">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span></div><div class="line"><span class="comment">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the</span></div><div class="line"><span class="comment">    GNU Lesser General Public License for more details.</span></div><div class="line"><span class="comment">    You should have received a copy of the GNU Lesser General Public License</span></div><div class="line"><span class="comment">    along with ITHACA-FV. If not, see &lt;http://www.gnu.org/licenses/&gt;.</span></div><div class="line"><span class="comment">Description</span></div><div class="line"><span class="comment">    Example of a state reconstruction in 1D heat transfer problem using EnKF</span></div><div class="line"><span class="comment">SourceFiles</span></div><div class="line"><span class="comment">    02enKF_1DinverseHeatTransfer.C</span></div><div class="line"><span class="comment">\*---------------------------------------------------------------------------*/</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;iostream&gt;</span></div><div class="line"><span class="preprocessor">#include &quot;fvCFD.H&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;fvOptions.H&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;simpleControl.H&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;IOmanip.H&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;Time.H&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="laplacianProblem_8H.html">laplacianProblem.H</a>&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="ITHACAutilities_8H.html">ITHACAutilities.H</a>&quot;</span></div><div class="line"><span class="preprocessor">#include &lt;Eigen/Dense&gt;</span></div><div class="line"><span class="preprocessor">#define _USE_MATH_DEFINES</span></div><div class="line"><span class="preprocessor">#include &lt;cmath&gt;</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="Foam2Eigen_8H.html">Foam2Eigen.H</a>&quot;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &quot;MUQ/Modeling/Distributions/Gaussian.h&quot;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="muq2ithaca_8H.html">muq2ithaca.H</a>&quot;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="02enKF__1DinverseHeatTransfer_8H.html">02enKF_1DinverseHeatTransfer.H</a>&quot;</span></div><div class="line"></div><div class="line"><span class="keyword">using namespace </span><a class="code" href="namespaceSPLINTER.html">SPLINTER</a>;</div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordtype">int</span> <a name="a0"></a><a class="code" href="02enKF__1DinverseHeatTransfer_8C.html#a0ddf1224851353fc92bfbff6f499fa97">main</a>(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span>* argv[])</div><div class="line">{</div><div class="line">    solverPerformance::debug = 1; <span class="comment">//No verbose output</span></div><div class="line">    <span class="comment">// Number of elements in the ensemble</span></div><div class="line">    <span class="keywordtype">int</span> Nseeds = 50;</div><div class="line">    <span class="comment">// Create the example object of the 02enKF_1DinverseHeatTransfer type</span></div><div class="line">    <a name="_a1"></a><a class="code" href="classEnKF__1DinverseHeatTransfer.html">EnKF_1DinverseHeatTransfer</a> example(argc, argv, Nseeds);</div><div class="line">    <span class="comment">// Reading parameters from file</span></div><div class="line">    <a name="_a2"></a><a class="code" href="classITHACAparameters.html">ITHACAparameters</a>* para = <a name="a3"></a><a class="code" href="classITHACAparameters.html#adf4e7e15954b8779d57ed6478a19027f">ITHACAparameters::getInstance</a>(example.<a name="a4"></a><a class="code" href="classlaplacianProblem.html#aace1f0215c66a5009c46f3f635a74bee">_mesh</a>(),</div><div class="line">                             example.<a name="a5"></a><a class="code" href="classlaplacianProblem.html#aee095e897c12912b7216fc194990a85b">_runTime</a>());</div><div class="line">    example.<a name="a6"></a><a class="code" href="classEnKF__1DinverseHeatTransfer.html#a63bef2300b33005604ae6c550dbbad78">k</a> = para-&gt;<a name="a7"></a><a class="code" href="classITHACAparameters.html#a87b488473043188ee5588db8a0bdd461">ITHACAdict</a>-&gt;lookupOrDefault&lt;<span class="keywordtype">double</span>&gt;(<span class="stringliteral">&quot;thermalConductivity&quot;</span>, 0);</div><div class="line">    <a name="a8"></a><a class="code" href="ITHACAassert_8H.html#af7024aa78cc4d1ce194c7983285ea1c9">M_Assert</a>(example.<a class="code" href="classEnKF__1DinverseHeatTransfer.html#a63bef2300b33005604ae6c550dbbad78">k</a> &gt; 0, <span class="stringliteral">&quot;thermalConductivity, k, not specified&quot;</span>);</div><div class="line">    example.<a name="a9"></a><a class="code" href="classEnKF__1DinverseHeatTransfer.html#ac273b904e59da03eff5d80f213f26bcc">rho</a> = para-&gt;<a class="code" href="classITHACAparameters.html#a87b488473043188ee5588db8a0bdd461">ITHACAdict</a>-&gt;lookupOrDefault&lt;<span class="keywordtype">double</span>&gt;(<span class="stringliteral">&quot;density&quot;</span>, 0);</div><div class="line">    <a class="code" href="ITHACAassert_8H.html#af7024aa78cc4d1ce194c7983285ea1c9">M_Assert</a>(example.<a class="code" href="classEnKF__1DinverseHeatTransfer.html#ac273b904e59da03eff5d80f213f26bcc">rho</a> &gt; 0, <span class="stringliteral">&quot;Density, rho, not specified&quot;</span>);</div><div class="line">    example.<a name="a10"></a><a class="code" href="classEnKF__1DinverseHeatTransfer.html#addf5c0f484820d71d63e9ac472e25036">Cp</a> = para-&gt;<a class="code" href="classITHACAparameters.html#a87b488473043188ee5588db8a0bdd461">ITHACAdict</a>-&gt;lookupOrDefault&lt;<span class="keywordtype">double</span>&gt;(<span class="stringliteral">&quot;heatCapacity&quot;</span>, 0);</div><div class="line">    <a class="code" href="ITHACAassert_8H.html#af7024aa78cc4d1ce194c7983285ea1c9">M_Assert</a>(example.<a class="code" href="classEnKF__1DinverseHeatTransfer.html#addf5c0f484820d71d63e9ac472e25036">Cp</a> &gt; 0, <span class="stringliteral">&quot;heatCapacity, Cp, not specified&quot;</span>);</div><div class="line">    <span class="comment">// Mesh and temperature field setup</span></div><div class="line">    fvMesh&amp; <a name="a11"></a><a class="code" href="ITHACA__CORE_2ITHACAsensitivity_2FiguresOfMerit_2createMesh_8H.html#ad3874bb3b9ab8a24930b4793e928108d">mesh</a> = example.<a class="code" href="classlaplacianProblem.html#aace1f0215c66a5009c46f3f635a74bee">_mesh</a>();</div><div class="line">    volScalarField&amp; <a name="a12"></a><a class="code" href="createT_8H.html#ab35c96e5601691f7270cfadc745a12d3">T</a> = example.<a name="a13"></a><a class="code" href="classlaplacianProblem.html#a7367f8517a5a9f7097c82bbf97eda7d4">_T</a>();</div><div class="line">    <span class="keywordtype">int</span> stateSize = <a class="code" href="createT_8H.html#ab35c96e5601691f7270cfadc745a12d3">T</a>.size();</div><div class="line">    scalar initialField = <a class="code" href="createT_8H.html#ab35c96e5601691f7270cfadc745a12d3">T</a>.internalField()[0];</div><div class="line">    <span class="comment">// Performes true solution</span></div><div class="line">    example.<a name="a14"></a><a class="code" href="classEnKF__1DinverseHeatTransfer.html#ad5059c4129be9302d0f0a729dcd83045">solveDirect</a>();</div><div class="line">    <span class="keywordtype">int</span> Ntimes = example.<a name="a15"></a><a class="code" href="classEnKF__1DinverseHeatTransfer.html#a90d8ada569fee71ac3764df689d42f2d">Ntimes</a>;</div><div class="line">    <span class="comment">// Setting up the densities</span></div><div class="line">    <span class="comment">// Gaussian densities are assumed</span></div><div class="line">    example.<a name="a16"></a><a class="code" href="classEnKF__1DinverseHeatTransfer.html#a512c42ef5e6f7f9bba86265d2fffebfc">priorSetup</a>(initialField, 0.7);</div><div class="line">    example.<a name="a17"></a><a class="code" href="classEnKF__1DinverseHeatTransfer.html#a7a47ca720e7ec5fbb1d940f4ab5e99cf">modelErrorSetup</a>(0.0, 0.7);</div><div class="line">    example.<a name="a18"></a><a class="code" href="classEnKF__1DinverseHeatTransfer.html#a7245485ff4b2a0d33744734d68e04133">measNoiseSetup</a>(0.0, 0.05);</div><div class="line">    Eigen::MatrixXd posteriorSamples(stateSize, Nseeds);</div><div class="line">    Eigen::MatrixXd priorSamples(stateSize, Nseeds);</div><div class="line">    <span class="comment">// Sampling prior density</span></div><div class="line">    example.<a name="a19"></a><a class="code" href="classEnKF__1DinverseHeatTransfer.html#af73e8d6c9113d2c3fbfb4db9113ec792">priorSampling</a>();</div><div class="line">    Eigen::MatrixXd posteriorMean(stateSize, Ntimes);</div><div class="line">    Eigen::MatrixXd minConfidence = posteriorMean;</div><div class="line">    Eigen::MatrixXd maxConfidence = minConfidence;</div><div class="line">    posteriorMean.col(0) = posteriorSamples.rowwise().mean();</div><div class="line">    <span class="comment">// Performs reconstruction</span></div><div class="line">    example.<a name="a20"></a><a class="code" href="classEnKF__1DinverseHeatTransfer.html#a965906710252eb3c975c740e8db22e49">reconstruct</a>();</div><div class="line">    <span class="keywordflow">return</span> 0;</div><div class="line">}</div><div class="line"><span class="comment">//--------</span></div><div class="line"><span class="comment"></span></div></div><!-- fragment --> </div><!-- contents -->
<!-- HTML footer for doxygen 1.8.14-->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.15
</small></address>
</body>
</html>
